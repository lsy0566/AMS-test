## Amazon EC2에서 애플리케이션의 가용성 향상

단일 EC2 인스턴스에서 애플리케이션 또는 웹 사이트 실행을 시작한 후 시간이 지나면서 수요를 충족하기 위해 두 개 이상의 인스턴스가 필요한 지점까지 트래픽이 증가하는 경우를 가정해 봅니다. 

AMI에서 여러 EC2 인스턴스를 시작한 다음 Elastic Load Balancing을 사용하여 애플리케이션에 대한 수신 트래픽을 EC2 인스턴스 간에 분산할 수 있습니다. 

=> 애플리케이션의 가용성이 향상됩니다. 

인스턴스를 여러 가용 영역에 배치하면 애플리케이션의 내결함성도 향상됩니다. 

가용 영역 하나가 중단되면 트래픽이 다른 가용 영역으로 라우팅됩니다.

- Amazon EC2 Auto Scaling

  - 애플리케이션에 대한 실행 인스턴스 수를 항상 최소한으로 유지할 수 있습니다. 
  - 인스턴스나 애플리케이션이 비정상일 때를 감지하고 자동으로 교체하여 애플리케이션의 가용성을 유지합니다. 

  - 지정한 기준을 사용하여 필요에 따라 자동으로 Amazon EC2 용량을 확장하거나 축소할 수 있습니다.

이 자습서에서는 Amazon EC2 Auto Scaling과 Elastic Load Balancing을 사용하여 로드 밸런서 뒤에 지정된 수의 정상 EC2 인스턴스를 유지합니다. 

트래픽이 로드 밸런서로 이동한 다음 인스턴스로 라우팅되므로 이러한 인스턴스에는 퍼블릭 IP 주소가 필요 없습니다.

### 사전 조건

- 두 개 이상의 가용 영역에 있는 퍼블릭 서브넷 하나로 가상 사설 클라우드(VPC)를 생성하였습니다. 
- VPC에서 인스턴스를 시작하였습니다.
- 인스턴스에 연결하여 인스턴스를 사용자 지정하였습니다. 
  - 소프트웨어 및 애플리케이션 설치, 데이터 복사, 추가 EBS 볼륨 연결 등을 예로 들 수 있습니다. 
- 인스턴스에서 애플리케이션을 테스트하여 인스턴스가 올바르게 구성되었는지 확인하였습니다.
- 인스턴스에서 사용자 지정 Amazon 머신 이미지(AMI)를 생성하였습니다. 
- (선택 사항) 더 이상 필요하지 않은 인스턴스를 종료하였습니다.
- 필요한 AWS에 대한 액세스 권한을 애플리케이션에 부여하는 IAM 역할을 생성하였습니다. 

### 애플리케이션 확장 및 로드 밸런싱

다음 절차를 사용하여 로드 밸런서를 만들고, 

인스턴스에 대한 시작 구성을 만든 다음. 

두 개 이상의 인스턴스가 포함된 Auto Scaling 그룹을 만들고. 

로드 밸런서를 Auto Scaling 그룹과 연결합니다.

#### 애플리케이션을 확장 및 로드 밸런싱

- https://console.aws.amazon.com/ec2/에서 Amazon EC2 콘솔을 엽니다.
- 탐색 창의 **로드 밸런싱** 아래에서 **로드 밸런서**를 선택합니다.
- **로드 밸런서 생성**을 선택하십시오.
- **Application Load Balancer**에서 **생성**을 선택합니다.
- **로드 밸런서 구성** 페이지에서 다음 작업을 수행하십시오.
  - **Name**에 로드 밸런서 이름을 입력합니다. 예: `my-2b`.
  - **체계**의 **internet-facing**은 기본값으로 유지합니다.
  - 포트 80에서 HTTP 트래픽을 수락하는 리스너를 뜻하는 **리스너**는 기본값으로 유지합니다.
  - **가용 영역**에서 인스턴스에 사용한 VPC를 선택합니다. 
    - ex) vpc-1f0ff774 (172.31.0.0/16)(기본값)
    - 해당 가용 영역의 퍼블릭 서브넷을 선택합니다. 
    - 두 번째 가용 영역에 대해 이 절차를 반복합니다.
  - **다음: 보안 설정 구성**을 선택합니다.

- 안전한 리스너를 사용하지 않고 있습니다. **다음: 보안 그룹 구성**을 선택합니다.

- **보안 그룹 구성** 페이지에서 다음 작업을 수행하십시오.

  - **Create a new security group**을 선택합니다.
  - 보안 그룹의 이름과 설명을 입력하거나 기본 이름과 설명을 유지합니다. 
    - 보안 그룹 이름 : load-balancer-wizard-2
    - 설명 : load-balancer-wizard-2 created on 2020-01-20T17:06:49.092+09:00
    - 유형 : 기본
  - 이 새 보안 그룹에는 리스너에 구성된 포트로 보내는 트래픽을 허용하는 규칙이 포함되어 있습니다.
  - **다음: 라우팅 구성**을 선택합니다.

- **라우팅 구성** 페이지에서 다음을 수행합니다.

  - **대상 그룹**에서는 기본값인 **새 대상 그룹**을 유지합니다.
  - **이름**에 대상 그룹의 이름을 입력합니다.
    - 이름 : load-balancer-wizard-2
  - **프로토콜**을 HTTP로, **포트**를 80으로, **대상 유형**을 인스턴스로 유지합니다.
  - **상태 검사**의 기본 프로토콜과 경로를 유지합니다.
  - **Next: Register Targets(다음: 대상 등록)**를 선택합니다.

- Amazon EC2 Auto Scaling을 사용하여 EC2 인스턴스를 대상 그룹에 추가해야 하므로 **대상 등록** 페이지에서 **다음: 검토**를 선택하여 다음 페이지로 계속합니다.

  - 로드 밸런서

    - |         이름 | my-2b                            |
      | -----------: | -------------------------------- |
      |         체계 | internet-facing                  |
      |       리스너 | 포트:80 - 프로토콜: HTTP         |
      |              |                                  |
      | IP 주소 유형 | ipv4                             |
      |          VPC | vpc-1f0ff774                     |
      |       서브넷 | subnet-c94aaaa2, subnet-c81e47b2 |
      |         태그 |                                  |

  - 보안 그룹

    - | 보안 그룹 | load-balancer-wizard-2 |
      | --------: | ---------------------- |
      |           |                        |

  - 라우팅

    - |          대상 그룹 | 새 대상 그룹           |
      | -----------------: | ---------------------- |
      |     대상 그룹 이름 | load-balancer-wizard-2 |
      |               포트 | 80                     |
      |          대상 유형 | instance               |
      |           프로토콜 | HTTP                   |
      | 상태 검사 프로토콜 | HTTP                   |
      |               경로 | /                      |
      |     상태 검사 포트 | traffic port           |
      |       정상 임계 값 | 5                      |
      |      비정상 임계값 | 2                      |
      |          제한 시간 | 5                      |
      |               간격 | 30                     |
      |          성공 코드 | 200                    |

- **검토** 페이지에서 **생성**을 선택합니다. 로드 밸런서가 생성된 후 **닫기**를 선택합니다.

- 탐색 창의 **AUTO SCALING**에서 **구성 시작**을 선택합니다.

  - Amazon EC2 Auto Scaling를 처음 사용하는 경우 시작 페이지가 표시됩니다.
  - 좌측 AUTO SCALING에서 **Auto Scaling 그룹**을 선택
  - **Auto Scaling 그룹 생성**을 클릭 
  - Auto Scaling 그룹 생성 마법사를 시작한 후 **시작 구성 생성**을 선택합니다.
  - **새시작 구성 생성**을 선택합니다.

- **AMI 선택** 페이지에서 **My AMIs(내 AMI)** 탭을 선택한 후 [사전 조건](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-increase-availability.html#scale-and-load-balance-prerequisites)에서 생성한 AMI를 선택합니다.

- **인스턴스 유형 선택** 페이지에서 인스턴스 유형을 선택한 후 **다음: 세부 정보 구성**을 선택합니다.

- **세부 정보 구성** 페이지에서 다음을 수행합니다.

  - **이름**에 시작 구성의 이름을 입력합니다(예 `my-launch-config`).
  - **IAM 역할**에서, [사전 조건](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-increase-availability.html#scale-and-load-balance-prerequisites)에서 만든 IAM 역할을 선택합니다.
  - (선택 사항) 스타트업 스크립트를 실행해야 하는 경우 **고급 세부 정보**를 확장하고 **사용자 데이터**에 스크립트를 입력합니다.
  - **Skip to review(검토로 이동)**를 선택합니다.

- **검토** 페이지에서 **보안 그룹 편집**을 선택합니다. 

  - 기존의 보안 그룹을 선택하거나 새로 만들 수 있습니다. 
  - 이 보안 그룹은 로드 밸런서의 HTTP 트래픽과 상태 확인을 허용해야 합니다. 
  - 인스턴스에 퍼블릭 IP 주소가 있는 경우 인스턴스에 연결해야 한다면 선택적으로 SSH 트래픽을 허용할 수 있습니다. 
  - 작업을 마쳤으면 **검토**를 선택합니다.

- **검토** 페이지에서 **시작 구성 생성**을 선택합니다.

- 메시지가 나타나면 기존 키 페어를 선택하거나 새 키 페어를 만들거나 키 페어 없이 진행합니다. 승인 확인란을 선택한 다음 **시작 구성 생성**을 선택합니다.

- 시작 구성이 생성된 후에는 Auto Scaling 그룹을 만들어야 합니다.

  - Amazon EC2 Auto Scaling을 처음 사용하고 Auto Scaling 그룹 생성 마법사를 사용 중인 경우 다음 단계로 자동으로 이동합니다.
  - 그렇지 않으면 **이 시작 구성을 사용하여 Auto Scaling 그룹 생성**을 선택합니다.
  - 

